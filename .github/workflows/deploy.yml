name: Deploy to VPS

on: 
  push: 
    branches:
     - master

jobs: 
  deploy: 
    runs-on: ubuntu-latest

    steps:
      - name: repo clone
        uses: actions/checkout@v3
      - name: build docker image
        run: |
          docker build -t tv-pl-app:latest .
      - name: Save Docker image to .tar
        run: |
          docker save tv_pl-app:latest -o tv_pl-app.tar
      - name: Copy image to VPS
        uses: appleboy/scp-action@v0.1.4
        with: 
          host: ${{secrets.VPS_HOST}}
          username: ${{secrets.VPS_USER}}
          key: ${{secrets.VPS_KEY}}
          source: "tv_pl-app.tar"
          target: "/opt"
      # - name: Run docker-compose on VPS
      #   uses: appleboy/ssh-action@v1.0.0
      #   with: 
      #     host: ${{ secrets.VPS_HOST }}
      #     username: ${{ secrets.VPS_USER }}
      #     key: ${{ secrets.VPS_KEY }}
      #     script: |
      #       docker load < /opt/tv_pl-app.tar
      #       cd /opt/tv_pl
      #       docker-compose up -d 
      - name: 🧠 Проверка SSH-доступа (dry run)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            echo "✅ SSH-соединение установлено, всё работает!"